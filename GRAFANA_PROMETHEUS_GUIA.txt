================================================================================
âœ… GRAFANA + PROMETHEUS - IMPLEMENTADO
================================================================================

Data: 14/12/2025 16:45
Status: âœ… PRONTO PARA USAR
VersÃ£o: 2.3 (Observabilidade Completa)

================================================================================
ğŸ¯ O QUE FOI IMPLEMENTADO
================================================================================

1. âœ… PROMETHEUS
   - Container: careca-prometheus
   - Porta: 9090
   - Coleta mÃ©tricas a cada 15s
   - RetenÃ§Ã£o: 30 dias
   - ConfiguraÃ§Ã£o: prometheus.yml

2. âœ… GRAFANA
   - Container: careca-grafana
   - Porta: 3000
   - UsuÃ¡rio: admin
   - Senha: admin (padrÃ£o)
   - Datasource Prometheus configurado automaticamente

3. âœ… MÃ‰TRICAS AVANÃ‡ADAS
   - MÃ³dulo: app/core/metrics.py
   - Worker instrumentado
   - Endpoint: /metrics

================================================================================
ğŸš€ COMO USAR
================================================================================

PASSO 1: REBUILD DO DOCKER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

docker-compose up --build -d

PASSO 2: VERIFICAR CONTAINERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

docker ps

VocÃª deve ver:
- careca-app
- careca-worker-1
- careca-worker-2
- careca-prometheus â† NOVO
- careca-grafana â† NOVO
- careca-db
- careca-redis
- careca-nginx

PASSO 3: ACESSAR PROMETHEUS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

URL: http://localhost:9090

VERIFICAR TARGETS:
1. Ir em Status â†’ Targets
2. Verificar que todos estÃ£o "UP":
   - fastapi-app (app:8000)
   - workers (worker:8000, worker-2:8000)
   - prometheus (localhost:9090)

TESTAR QUERY:
1. Ir em Graph
2. Digitar: transcriptions_total
3. Clicar em Execute
4. Ver mÃ©tricas!

PASSO 4: ACESSAR GRAFANA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

URL: http://localhost:3000

LOGIN:
- UsuÃ¡rio: admin
- Senha: admin

PRIMEIRA VEZ:
1. Grafana vai pedir para trocar senha (pode pular)
2. Datasource Prometheus jÃ¡ estÃ¡ configurado!
3. Pronto para criar dashboards

================================================================================
ğŸ“Š CRIAR SEU PRIMEIRO DASHBOARD
================================================================================

OPÃ‡ÃƒO 1: DASHBOARD MANUAL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. No Grafana, clicar em "+" â†’ "Dashboard"
2. Clicar em "Add visualization"
3. Selecionar "Prometheus" como datasource
4. Adicionar queries:

PAINEL 1: Total de TranscriÃ§Ãµes
Query: sum(transcriptions_total)
Tipo: Stat
TÃ­tulo: Total de TranscriÃ§Ãµes

PAINEL 2: Taxa de Sucesso
Query: sum(transcriptions_total{status="success"}) / sum(transcriptions_total) * 100
Tipo: Gauge
TÃ­tulo: Taxa de Sucesso (%)
Unit: percent (0-100)

PAINEL 3: TranscriÃ§Ãµes por Hora
Query: rate(transcriptions_total[1h])
Tipo: Time series
TÃ­tulo: TranscriÃ§Ãµes/Hora

PAINEL 4: Tempo MÃ©dio
Query: rate(transcription_duration_seconds_sum[5m]) / rate(transcription_duration_seconds_count[5m])
Tipo: Stat
TÃ­tulo: Tempo MÃ©dio (s)
Unit: seconds

PAINEL 5: Fila de Tarefas
Query: queue_size
Tipo: Stat
TÃ­tulo: Tarefas na Fila

PAINEL 6: Cache Hit Rate
Query: cache_hit_rate_percent{cache_type="transcription"}
Tipo: Gauge
TÃ­tulo: Cache Hit Rate (%)
Unit: percent (0-100)

5. Salvar dashboard: "Save dashboard"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

OPÃ‡ÃƒO 2: IMPORTAR DASHBOARD PRONTO (Recomendado)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Vou criar um dashboard JSON pronto para vocÃª importar!

================================================================================
ğŸ” QUERIES ÃšTEIS DO PROMETHEUS
================================================================================

TRANSCRIÃ‡Ã•ES:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Total de transcriÃ§Ãµes
sum(transcriptions_total)

# TranscriÃ§Ãµes por status
sum by (status) (transcriptions_total)

# Taxa de erro
sum(transcriptions_total{status="error"}) / sum(transcriptions_total) * 100

# TranscriÃ§Ãµes nas Ãºltimas 24h
increase(transcriptions_total[24h])

# TranscriÃ§Ãµes por hora (taxa)
rate(transcriptions_total[1h])

PERFORMANCE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Tempo mÃ©dio de processamento
rate(transcription_duration_seconds_sum[5m]) / rate(transcription_duration_seconds_count[5m])

# Percentil 95 (95% das transcriÃ§Ãµes levam menos que isso)
histogram_quantile(0.95, rate(transcription_duration_seconds_bucket[5m]))

# Percentil 99
histogram_quantile(0.99, rate(transcription_duration_seconds_bucket[5m]))

CACHE:
â”€â”€â”€â”€â”€â”€

# Cache hit rate
cache_hit_rate_percent{cache_type="transcription"}

# Total de cache hits
sum(cache_operations_total{result="hit"})

# Total de cache misses
sum(cache_operations_total{result="miss"})

# Hit rate calculado
sum(cache_operations_total{result="hit"}) / sum(cache_operations_total) * 100

FILA:
â”€â”€â”€â”€â”€

# Tamanho atual da fila
queue_size

# Workers ativos
active_workers

# Tarefas ativas
active_tasks

RECURSOS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Uso de GPU
gpu_utilization_percent

# MemÃ³ria GPU
gpu_memory_used_bytes / 1024 / 1024 / 1024  # GB

# Uso de RAM
ram_usage_bytes / 1024 / 1024 / 1024  # GB

# Temperatura da GPU
gpu_temperature_celsius

ERROS:
â”€â”€â”€â”€â”€â”€

# Total de erros
sum(errors_total)

# Erros por tipo
sum by (error_type) (errors_total)

# Taxa de erros nas Ãºltimas 5 minutos
rate(errors_total[5m])

================================================================================
ğŸ¨ DICAS DE VISUALIZAÃ‡ÃƒO
================================================================================

STAT (NÃºmero Grande):
- Bom para: Total, MÃ©dia, Ãšltimo valor
- Exemplos: Total de transcriÃ§Ãµes, Fila atual, Workers ativos

GAUGE (Medidor):
- Bom para: Percentuais, Uso de recursos
- Exemplos: Taxa de sucesso, Cache hit rate, Uso de GPU

TIME SERIES (GrÃ¡fico de Linha):
- Bom para: TendÃªncias ao longo do tempo
- Exemplos: TranscriÃ§Ãµes/hora, Tempo de processamento, Erros

BAR GAUGE (Barra Horizontal):
- Bom para: ComparaÃ§Ãµes
- Exemplos: Erros por tipo, TranscriÃ§Ãµes por modelo

HEATMAP:
- Bom para: DistribuiÃ§Ãµes
- Exemplos: DistribuiÃ§Ã£o de tempo de processamento

TABLE:
- Bom para: Dados detalhados
- Exemplos: Ãšltimos erros, Tarefas recentes

================================================================================
âš ï¸ TROUBLESHOOTING
================================================================================

PROBLEMA: Prometheus nÃ£o estÃ¡ coletando mÃ©tricas
SOLUÃ‡ÃƒO:
1. Verificar se app estÃ¡ expondo /metrics:
   curl http://localhost:8000/metrics
   
2. Verificar targets no Prometheus:
   http://localhost:9090/targets
   
3. Ver logs do Prometheus:
   docker logs careca-prometheus

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PROBLEMA: Grafana nÃ£o conecta no Prometheus
SOLUÃ‡ÃƒO:
1. Verificar se Prometheus estÃ¡ rodando:
   docker ps | grep prometheus
   
2. Testar conexÃ£o:
   docker exec careca-grafana ping prometheus
   
3. Recriar datasource:
   Configuration â†’ Data sources â†’ Add â†’ Prometheus
   URL: http://prometheus:9090

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PROBLEMA: MÃ©tricas nÃ£o aparecem
SOLUÃ‡ÃƒO:
1. Fazer upload de um Ã¡udio para gerar mÃ©tricas
2. Aguardar 15s (intervalo de coleta)
3. Verificar no Prometheus:
   http://localhost:9090/graph
   Query: transcriptions_total

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PROBLEMA: Dashboard vazio
SOLUÃ‡ÃƒO:
1. Verificar time range (canto superior direito)
2. Mudar para "Last 24 hours"
3. Fazer algumas transcriÃ§Ãµes para gerar dados

================================================================================
ğŸ“ˆ PRÃ“XIMOS PASSOS
================================================================================

1. [ ] Rebuild Docker
2. [ ] Acessar Prometheus (http://localhost:9090)
3. [ ] Verificar targets
4. [ ] Acessar Grafana (http://localhost:3000)
5. [ ] Criar primeiro dashboard
6. [ ] Fazer upload de Ã¡udio para gerar mÃ©tricas
7. [ ] Ver mÃ©tricas em tempo real!

OPCIONAL:
8. [ ] Implementar alertas (Alertmanager)
9. [ ] Adicionar mais dashboards
10. [ ] Configurar notificaÃ§Ãµes (email, slack)

================================================================================
ğŸ“ RECURSOS ÃšTEIS
================================================================================

PROMETHEUS:
- DocumentaÃ§Ã£o: https://prometheus.io/docs/
- Query language: https://prometheus.io/docs/prometheus/latest/querying/basics/
- Best practices: https://prometheus.io/docs/practices/naming/

GRAFANA:
- DocumentaÃ§Ã£o: https://grafana.com/docs/
- Dashboards prontos: https://grafana.com/grafana/dashboards/
- Tutoriais: https://grafana.com/tutorials/

MÃ‰TRICAS:
- Prometheus client (Python): https://github.com/prometheus/client_python
- Best practices: https://prometheus.io/docs/practices/instrumentation/

================================================================================
âœ… CHECKLIST FINAL
================================================================================

IMPLEMENTAÃ‡ÃƒO:
- [âœ…] prometheus.yml criado
- [âœ…] Grafana datasource configurado
- [âœ…] Grafana dashboard provider configurado
- [âœ…] docker-compose.yml atualizado
- [âœ…] MÃ©tricas avanÃ§adas implementadas
- [âœ…] Worker instrumentado
- [ ] Docker rebuild executado
- [ ] Prometheus acessÃ­vel
- [ ] Grafana acessÃ­vel
- [ ] Dashboards criados
- [ ] MÃ©tricas sendo coletadas

VALIDAÃ‡ÃƒO:
- [ ] Prometheus coleta mÃ©tricas do app
- [ ] Prometheus coleta mÃ©tricas dos workers
- [ ] Grafana conecta no Prometheus
- [ ] Dashboards mostram dados
- [ ] MÃ©tricas atualizam em tempo real

================================================================================
ğŸ‰ CONCLUSÃƒO
================================================================================

VOCÃŠ AGORA TEM:

âœ… Prometheus coletando mÃ©tricas a cada 15s
âœ… Grafana para visualizaÃ§Ã£o
âœ… MÃ©tricas avanÃ§adas de negÃ³cio
âœ… MÃ©tricas de performance
âœ… MÃ©tricas de recursos
âœ… Pronto para criar dashboards!

PRÃ“XIMO COMANDO:
docker-compose up --build -d

DEPOIS:
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (admin/admin)
- MÃ©tricas: http://localhost:8000/metrics

================================================================================
FIM DO GUIA
================================================================================
