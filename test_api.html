<!DOCTYPE html>
<html>

<head>
    <title>Teste API - Resumo e T√≥picos</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #0f0;
        }

        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
        }

        button {
            background: #0f0;
            color: #000;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin: 5px;
        }

        input {
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 8px;
            width: 400px;
        }

        .error {
            color: #f00;
        }

        .success {
            color: #0f0;
        }
    </style>
</head>

<body>
    <h1>üîç Teste de API - Resumo e T√≥picos</h1>

    <div class="section">
        <h2>1. Login</h2>
        <input type="text" id="username" placeholder="Username" value="admin">
        <input type="password" id="password" placeholder="Password" value="">
        <button onclick="doLogin()">Login</button>
        <div id="login-result"></div>
    </div>

    <div class="section">
        <h2>2. Buscar Hist√≥rico</h2>
        <button onclick="getHistory()">Buscar Transcri√ß√µes</button>
        <div id="history-result"></div>
    </div>

    <div class="section">
        <h2>3. Testar Resultado Espec√≠fico</h2>
        <input type="text" id="task-id" placeholder="Task ID">
        <button onclick="getResult()">Buscar Resultado</button>
        <div id="result-output"></div>
    </div>

    <script>
        let token = null;

        async function doLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('login-result');

            try {
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const res = await fetch('/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (!res.ok) throw new Error('Login falhou');

                const data = await res.json();
                token = data.access_token;

                resultDiv.innerHTML = `<div class="success">‚úÖ Login OK! Token: ${token.substring(0, 20)}...</div>`;
            } catch (e) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${e.message}</div>`;
            }
        }

        async function getHistory() {
            const resultDiv = document.getElementById('history-result');

            if (!token) {
                resultDiv.innerHTML = '<div class="error">‚ùå Fa√ßa login primeiro!</div>';
                return;
            }

            try {
                const res = await fetch('/api/history', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Falha ao buscar hist√≥rico');

                const data = await res.json();

                let html = `<div class="success">‚úÖ Encontradas ${data.length} transcri√ß√µes:</div><pre>`;

                data.slice(0, 5).forEach(task => {
                    html += `\nID: ${task.task_id}
Arquivo: ${task.filename}
Status: ${task.status}
Summary: ${task.summary ? '‚úÖ SIM (' + task.summary.substring(0, 50) + '...)' : '‚ùå N√ÉO'}
Topics: ${task.topics ? '‚úÖ SIM (' + task.topics + ')' : '‚ùå N√ÉO'}
---`;
                });

                html += '</pre>';
                resultDiv.innerHTML = html;

                // Auto-preencher o primeiro task_id
                if (data.length > 0) {
                    document.getElementById('task-id').value = data[0].task_id;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${e.message}</div>`;
            }
        }

        async function getResult() {
            const taskId = document.getElementById('task-id').value;
            const resultDiv = document.getElementById('result-output');

            if (!token) {
                resultDiv.innerHTML = '<div class="error">‚ùå Fa√ßa login primeiro!</div>';
                return;
            }

            if (!taskId) {
                resultDiv.innerHTML = '<div class="error">‚ùå Insira um Task ID!</div>';
                return;
            }

            try {
                const res = await fetch(`/api/result/${taskId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Falha ao buscar resultado');

                const data = await res.json();

                let html = '<div class="success">‚úÖ Resposta da API:</div><pre>';
                html += JSON.stringify(data, null, 2);
                html += '</pre>';

                html += '<h3>An√°lise:</h3><pre>';
                html += `Summary presente: ${data.summary ? '‚úÖ SIM' : '‚ùå N√ÉO'}`;
                if (data.summary) html += `\nConte√∫do: ${data.summary}`;

                html += `\n\nTopics presente: ${data.topics ? '‚úÖ SIM' : '‚ùå N√ÉO'}`;
                if (data.topics) html += `\nConte√∫do: ${data.topics}`;
                html += '</pre>';

                resultDiv.innerHTML = html;
            } catch (e) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${e.message}</div>`;
            }
        }
    </script>
</body>

</html>